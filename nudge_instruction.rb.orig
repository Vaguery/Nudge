class String
  def to_instruction_class
    eval self.gsub('?','_q').
    gsub(/^([a-z\d])|_([a-z\d])/) {|s| s.upcase}.
    gsub(/_/,'')
  end
end



class NudgeInstruction
  INSTRUCTIONS = {}
  
  
  def self.to_nudge_symbol
    self.name.
    gsub(/^.*::/, '').
    gsub(/Q$/,'?').
    gsub(/([A-Z]+)([A-Z][a-z])/,'\1_\2').
    gsub(/([a-z\d])([A-Z])/,'\1_\2').
    downcase.intern
  end
  
  
  def self.to_nudge_string
    self.to_nudge_symbol.to_s
  end
  
  
  def NudgeInstruction.inherited (klass)
    klass.const_set("REQUIREMENTS", {})
    
    instruction_name = klass.name.
      gsub(/^.*::/, '').
      gsub(/Q$/,'?').
      gsub(/([A-Z]+)([A-Z][a-z])/,'\1_\2').
      gsub(/([a-z\d])([A-Z])/,'\1_\2').
      downcase.intern
    
    INSTRUCTIONS[instruction_name] = klass
    
    def klass.get (n, value_type)
      self::REQUIREMENTS[value_type] = n
      
      self.module_eval <<-END
        def #{value_type} (n)
          @argument_stacks[:#{value_type}][n]
        end
      END
    end
  end
  
  
  def NudgeInstruction.execute (instruction_name, outcome_data)
    INSTRUCTIONS[instruction_name].new(outcome_data).execute
  end
  
  
  def initialize (outcome_data)
    @outcome_data = outcome_data
    @argument_stacks = Hash.new {|hash, key| hash[key] = [] }
    @result_stacks = Hash.new {|hash, key| hash[key] = [] }
  end
  
<<<<<<< HEAD
  
  def put (value_type, result)
    result_stack = @result_stacks[value_type] ||= []
    result_stack << (value_type == :exec ? result : result.to_s)
  end
  
  
  def get_required_arguments! (stacks)
=======
  def execute
    stacks = @outcome_data.stacks
    
>>>>>>> e59aa93c6d970f2651f2d6ed9771ad4e9a93a813
    self.class::REQUIREMENTS.each do |value_type, n|
      return unless (stack = stacks[value_type]) && (stack.length >= n)
    end.each do |value_type, n|
      stack = stacks[value_type]
      argument_stack = @argument_stacks[value_type]
      
      n.times do
        argument = (value_type == :exec) ? stack.pop : stack.pop.send(:"to_#{value_type}")
        argument_stack << argument
      end
    end
<<<<<<< HEAD
  end
  
  
  def push_results_to_stacks! (stacks)
=======
    
    process
    
>>>>>>> e59aa93c6d970f2651f2d6ed9771ad4e9a93a813
    @result_stacks.each do |value_type, result_stack|
      stacks[value_type].concat result_stack
    end
    
  rescue NudgeError => error
    stacks[:error] << error.string
  end
  
  def put (value_type, result)
    result = (value_type == :exec) ? result : result.to_s
    @result_stacks[value_type] << result
  end
end
